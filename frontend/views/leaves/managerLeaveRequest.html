<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management</title>
    <!-- <link rel="stylesheet" href="./managerLeaveRequest.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* body {
            display: flex;
            align-items: center;
            justify-content: center;
            
            background: linear-gradient(135deg, #2e66a6, #902340); 
            
        } */

        .container {
            max-width: 2400px;
            height: 300px;
            padding: 25px;
            top: 50px;
            /* background: linear-gradient(135deg, #96bdea, #e22f5f); */
            background-color: #1f293a;
            border-radius: 12px;
            /* box-shadow: 25px 26px rgba(0, 0, 0, 0.2); */
            transition: opacity 3s ease, transform 3s ease;
            font-size: 22px;
        }

        .side-image {
            border: none;
            outline: none;
            opacity: 3;
            filter: grayscale(20%) contrast(50%);
            border-radius: 50px;
            position: absolute;
            left: 0px;
            top: 0px;
            width: 50%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: -1;
            float: left;
        }

        .icon {
            text-align: center;
            font-size: 3rem;
            color: #ffffff;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }


        .btn-logout {
            padding: 5px 15px;
            border-style: outset;
            border-color: #c31a4d;
            background: #da1c1c;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
        }

        .btn-logout:hover {
            background: #ff0000;
        }

        h1 {
            margin: 20px 0;
            text-align: center;
            color: rgb(255, 255, 255);
            font-size: larger;
            font-weight: bold;
            font-size: 2rem;

        }

        .status.pending {
            color: rgb(219, 223, 24);


        }

        .status.approved {
            color: rgb(25, 209, 25);
        }

        .status.rejected {
            color: red;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffffff;
        }



        input,
        select {
            background-color: #e0c3cf;
            width: 100%;
            padding: 10px;
            border-color: #e94e77;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
            color: #000000;

        }

        .status1 {
            background-color: #ffffff;
            border-style: none;
            /* padding: 10px; */
            color: #050505;
        }

        #statusFilter {
            background-color: #ffffff;
            border-color: #ffffff;
            border-style: groove;

        }


        #statusFilter:hover {
            background-color: #ffffff;
        }

        select:focus {
            border-color: #650318;
        }

        .leave-list {
            list-style-type: none;
            padding: 4px;
            margin-top: 5px;
            background-color: #1f293a;


        }


        .leave-list li {
            background: #ffffff;
            margin-bottom: 4px;
            padding: 20px;
            border-radius: 5px;
            /* padding-left: 50px;
            padding-bottom: 20px; */


            /* margin-left: 5px; */

            /* box-shadow: 0 2px 5px rgba(231, 12, 12, 0.1); */
        }



        .btn {
            background-color: blue;
            color: rgb(255, 255, 255);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-approve {
            background-color: rgb(25, 209, 25);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-reject {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* .modal {
            display: none;
            
            position: fixed;
            z-index: 1000;
            
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            font-family: Arial, sans-serif;
        }

        .modal h3 {
            color: #000000;
            margin-bottom: 15px;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #rejectForm label {
            font-weight: bold;
            color: #333;
        }

        #rejectForm textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            resize: none;
            box-sizing: border-box;
        }

        textarea {
            width: 90%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
        }

        textarea:focus {
            border-color: #4a90e2;
        }

        .btn {
            font-size: 1rem;
            border-radius: 20px;
            cursor: pointer;

        }

        .btn:hover {
            background: #000000;
        } */
        /* Modal Background Overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 99px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

   
        .modal-content {
            background-color: #1f293a;
            margin-top: 125px;
            margin-left: 700px;
            padding: 10px;
            border-radius: 5px;
            width: 600px;
            height: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

     
        .modal-content h3 {
            font-size: 24px;
            color: #fff;
            /* background-color: #2b2f3a; */
            padding: 10px;
            margin-top: 0;
            text-align: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

       
        .close {
            color: #ffffff;
            float: right;
            margin-top: 1px;
            margin-right: 12px;
            font-size: 50px;
            font-weight: bold;
        }

        .close:hover {
            color: #c7c1c1;
            text-decoration: none;
            cursor: pointer;
        }

        /* Form Styling */
        .modal-content form {
            max-width: 600px;
            height: 250px;
            /* padding-top: 10px; */
            margin: 10px ;
            padding: 10px;
            border: 2px solid #050505;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            font-family: Arial, sans-serif;
        }

        .modal-content label {
            font-weight: bold;
            color: #000000;
        }

        .modal-content input[type="text"],
        .modal-content input[type="date"] {
            width: 100%;
            padding: 8px;
            margin-top: 2px;
            border: 2px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
            background-color: #fff;
            box-sizing: border-box;
            font-weight: bold;
        }

        /* Update Button */
        .modal-content button[type="submit"] {
            width: 180px;
            padding: 5px;
            background-color:  #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        .modal-content button[type="submit"]:hover {
            background-color: blue;
        }



        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        @media (max-width: 500px) {
            .container {
                padding: 10px;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header">
            <h1 id="welcomeMessage"></h1>
            <button id="logoutButton" class="btn-logout">Log out</button>
        </div>
        <div class="icon">
            <i class="fa fa-user-times" aria-hidden="true"></i>
            <i class="fa fa-check-square" aria-hidden="true"></i>
        </div>

        <h1>Manage Employee Leave Requests</h1>

        <label for="statusFilter">Filter by Status:</label>
        <select id="statusFilter">


            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
        </select>

        <ul id="leaveRequests" class="leave-list"></ul>
    </div>

    <!-- Modal for Rejecting Leave -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>

            <h3>Reject Leave Request</h3>

            <form id="rejectForm">
                <label for="rejectionReason">Reason for Rejection</label>
                <textarea id="rejectionReason" name="rejectionReason" required></textarea><br><br>
                <button type="submit" class="btn">Submit</button>
            </form>

        </div>
    </div>
    <!-- <img src="./wpsierra-featured-image.jpg" alt="Side Image" class="side-image"> -->


    <script>
        document.addEventListener('DOMContentLoaded', async function () {


            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

            if (!loggedInUser) {
                alert('You must log in first!');
                window.location.href = 'login.html';
                return;
            }
            if (loggedInUser.role == 'Employee') {
                window.location.href = 'leaveRequest.html';
            }
            // Display welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            welcomeMessage.textContent = `Welcome Back, ${loggedInUser.firstName} ${loggedInUser.lastName}`;

            // Logout button functionality
            // const logoutButton = document.getElementById('logoutButton');
            // logoutButton.addEventListener('click', function () {
            //     localStorage.removeItem('loggedInUser');
            //     alert('You have been logged out.');
            //     window.location.href = 'login.html';
            // });
            const logoutButton = document.getElementById('logoutButton');
            logoutButton.addEventListener('click', function () {
                console.log("hmjg")
                localStorage.removeItem('loggedInUser');
                alert('You have been logged out.');
                window.location.href = '/login';
            });

            const statusFilter = document.getElementById('statusFilter');
            const leaveRequestsList = document.getElementById('leaveRequests');
            let leaveRequests = [];

            statusFilter.addEventListener('change', function () {
                renderLeaveRequests();
            });

            async function loadLeaveRequests() {
                try {
                    const response = await fetch(`http://localhost:3000/leaveRequests?employeeId_ne=${loggedInUser.employeeId}&_embed=employee`);
                    leaveRequests = await response.json();
                    renderLeaveRequests();
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            function renderLeaveRequests() {
                const status = statusFilter.value;
                leaveRequestsList.innerHTML = '';

                const filteredRequests = leaveRequests.filter(request => {
                    return status === 'all' || request.status.toLowerCase() === status;
                });

                filteredRequests.forEach(request => {
                    const li = document.createElement('li');
                    li.classList.add('leave-item');
                    li.innerHTML = `<div class= "status1">
                <div><b>Requested By : ${request.employee.firstName + " " + request.employee.lastName}</b></div>
                <div>Reason: ${request.reason}</div>
                <div>From: ${request.dateFrom}</div>
                <div>Days: ${request.numOfDays}</div>
                <div>Applied on: ${request.applicationDate}</div>
                <div>Status: <span class="status ${request.status.toLowerCase()}">${request.status}</span></div>
                ${request.status === 'Pending' ? `
                <button class="btn-approve" data-id="${request.id}">Approve</button>
                <button class="btn-reject" data-id="${request.id}">Reject</button>` : ''}</div>
            `;
                    leaveRequestsList.appendChild(li);
                });

                document.querySelectorAll('.btn-approve').forEach(button => {
                    button.addEventListener('click', handleApprove);
                });

                document.querySelectorAll('.btn-reject').forEach(button => {
                    button.addEventListener('click', handleReject);
                });
            }

            async function handleApprove(event) {
                const requestId = event.target.dataset.id;
                const request = leaveRequests.find(req => req.id == requestId);
                if (request) {
                    request.status = 'Approved';
                    request.processedDate = new Date().toISOString().split('T')[0]; // Adding processed date

                    try {
                        await fetch(`http://localhost:3000/leaveRequests/${requestId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(request)
                        });
                        loadLeaveRequests();
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }
            }

            const rejectModal = document.getElementById('rejectModal');
            const rejectForm = document.getElementById('rejectForm');
            let requestToReject = null;

            function handleReject(event) {
                requestToReject = leaveRequests.find(req => req.id == event.target.dataset.id);
                if (requestToReject) {
                    rejectModal.style.display = 'block';
                }
            }

            rejectForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const rejectionReason = document.getElementById('rejectionReason').value;

                if (requestToReject) {
                    requestToReject.status = 'Rejected';
                    requestToReject.processedDate = new Date().toISOString().split('T')[0];
                    requestToReject.rejectionReason = rejectionReason;

                    try {
                        await fetch(`http://localhost:3000/leaveRequests/${requestToReject.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestToReject)
                        });
                        rejectModal.style.display = 'none';
                        loadLeaveRequests();
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }
            });

            // Close modal
            document.querySelector('.close').addEventListener('click', function () {
                rejectModal.style.display = 'none';
            });

            // Load initial leave requests
            loadLeaveRequests();
        });
        F
    </script>
</body>

</html>